#!ruby -Ku

# 指定したツイートIDを検索するテスト

require 'twitter'
require 'yaml'
require 'pp'

require './search'
require './tweet'
require './bot'
require './custom_bot'

# 非公式RT 159524563724681216 161004300682801152
# 鍵アカ。しかしsearch not foundは変 160672123780726784
# 削除済み 161744176076177408 161729076481110016 163797707889192961 164658378143051776
# ユーザーごと削除 161789475062693888
# ユーザー名が変わったケース。旧ユーザー名のURLでアクセスできる 164567781264736256
# 2回目のRT失敗 161653579399180289 128033080370937857
# 原因不明。＼／ を削除してもだめ 160959001331376128 161623380125159425
# 切り捨て位置が悪い 162484051633115136
# URLのドメイン部分がIPになってる 155876798524178433

# 対応済み。後でレグレッションテストを作る 160626812563619842 160641912154497024 161698877366484993 163103130773487617 161019399933923328 162725643631591424 163525916629286912 163193727869911041 163541016178196480 164567781264736256

TEST_VECTOR = {
  '1000favs' => {
    # 未通過
    # 167078904719347712 => 144968448982790144,
    # 167833879179296770 => 138893779821264897,
    # 169365485702492160 => 63144629813518336, # アカ名 Natsuki_mp => twilight060524
    # 169259801681989633 => 145112884437987328, # ヨーロッパ文字1文字文字化け
    # 169274888727707648 => 145006423846289408, # ヨーロッパ文字1文字文字化け
    # 166807114260561920 => 145431108153114625, # 削除
    # 167124203479371776 => 47314031979143168, # ユーザー削除
    # 167471492060286977 => 121472417787936768, # Unicode大量文字化け
    # 167788582575157248 => 46397445759975425, # 削除
    # 167848979005046784 => nil, # 鍵アカ
  },
  
  '100favs' => {
    # 未通過
    # 155492861729705984 => 110322819149201408, # 名言botの方を拾った
    # 155639929655934976 => 104766160456794112, # 微妙に改変
  },

  '1000Retweets' => {
    # 未通過
    # 167847757665673216 => 52286464767180800,
    # 168194982480576512 => 16363082880122880,
    # 168270544741990400 => 129345667108843520, # アカ名 To_aru_Kanon => mjkiyama
    # 169191515980181504 => 120063171099758592,
    # 168255384790896641 => 46881405757689856, # 削除
  },

  'omosiro_tweet' => {
    # 通過
    # 170119508755873793 => 37824154464034816,
    # 170100631871295488 => 37807441722867712,
    # 170075467402051584 => 37805261322326016,
    # 170070436065984514 => 37527051611279360,
    # 170065399906447360 => 37713009765777409,

    # 未通過
    # 170035203962703872 => 37728097126203392, # favstarのページのクロールが必要
    # 170096860458008576 => 37771396985790464, # search not found
  },
}

config = YAML.load_file("config.yaml")

TEST_VECTOR.each do |bot_name, tweet_ids|
  setting = config['bots'][bot_name]

  bot = eval(setting['type']).new(setting)

  tweet_ids.each do |copy_id, answer|
    print "tweet #{copy_id} => "

    status = Twitter.status(copy_id)

    original_id = bot.find_original_id(status)

    if original_id && original_id == answer
      puts "ok: #{original_id}"
    elsif original_id && original_id != answer
      puts "ng: #{original_id} expected: #{answer}"
    end

    # GoogleのRate limit対策
    sleep 10
  end
end
